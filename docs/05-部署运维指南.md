# ShareSkill 部署运维指南

## 一、GitHub Secrets 配置

在 GitHub 仓库的 Settings > Secrets and variables > Actions 中配置以下 secrets：

### 1.1 Pipeline (数据采集) 必需

| Secret 名称 | 说明 | 获取方式 |
|-------------|------|----------|
| `SUPABASE_URL` | Supabase 项目 URL | Supabase Dashboard > Settings > API > Project URL |
| `SUPABASE_SERVICE_KEY` | Supabase Service Role Key | Supabase Dashboard > Settings > API > service_role (secret) |
| `GITHUB_TOKENS` | GitHub PAT，多个用逗号分隔 | GitHub Settings > Developer settings > Personal access tokens |
| `OPENAI_API_KEY` | OpenAI API Key (Embedding) | OpenAI Platform > API Keys |
| `GEMINI_API_KEY` | Gemini API Key (LLM 分析) | Google AI Studio > API Keys |

### 1.2 Web 部署 (Vercel) 必需

| Secret 名称 | 说明 | 获取方式 |
|-------------|------|----------|
| `VERCEL_TOKEN` | Vercel 访问令牌 | Vercel Dashboard > Settings > Tokens |
| `VERCEL_ORG_ID` | Vercel 组织 ID | Vercel Dashboard > Settings > General > Vercel ID |
| `VERCEL_PROJECT_ID` | Vercel 项目 ID | Vercel Project > Settings > General > Project ID |

### 1.3 NPM 发布 (Hub MCP Server) 必需

| Secret 名称 | 说明 | 获取方式 |
|-------------|------|----------|
| `NPM_TOKEN` | NPM 发布令牌 | npmjs.com > Access Tokens > Generate New Token (Automation) |

## 二、GitHub Actions 工作流

### 2.1 Pipeline (pipeline.yml)

**触发条件**：
- 定时：每 6 小时自动运行 (`0 */6 * * *`)
- 手动：支持 `workflow_dispatch` 手动触发

**手动触发参数**：
- `full_refresh`: 设为 `true` 时忽略 SHA 检查，重新处理所有 Skills

**运行步骤**：
1. Checkout 代码
2. 安装 pnpm + Node.js 20
3. 安装依赖
4. 构建 shared 和 db 包
5. 运行 Pipeline

**超时**：60 分钟

### 2.2 Deploy (deploy.yml)

**触发条件**：
- Push 到 `main` 分支
- 且修改了 `apps/web/**`、`packages/**` 或 `pnpm-lock.yaml`

**运行步骤**：
1. Checkout 代码
2. 安装依赖
3. 构建 packages
4. 部署到 Vercel (生产环境)

### 2.3 Release (release.yml)

**触发条件**：
- Push tag 匹配 `hub-v*` (如 `hub-v1.0.0`)

**运行步骤**：
1. Checkout 代码
2. 安装依赖
3. 构建 hub 包
4. 发布到 npm

## 三、配置步骤

### Step 1: 创建 Supabase 项目

1. 访问 https://supabase.com/dashboard
2. 创建新项目，选择离用户最近的区域
3. 等待项目初始化完成
4. 在 Settings > API 获取：
   - Project URL → `SUPABASE_URL`
   - service_role key → `SUPABASE_SERVICE_KEY`

### Step 2: 初始化数据库

连接到 Supabase SQL Editor，执行以下操作：

```sql
-- 1. 启用必要扩展
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS unaccent;

-- 2. 执行 migrations 目录下的所有 SQL 文件
-- 按文件名顺序执行
```

或使用 Supabase CLI：

```sh
supabase db push
```

### Step 3: 创建 GitHub Token

1. 访问 https://github.com/settings/tokens
2. 点击 "Generate new token (classic)"
3. 选择权限：`repo` (读取公开仓库)
4. 复制 token

建议创建多个 token 并用逗号分隔，避免 rate limit：

```
ghp_xxx1,ghp_xxx2,ghp_xxx3
```

### Step 4: 获取 LLM API Keys

**OpenAI (用于 Embedding)**：
1. 访问 https://platform.openai.com/api-keys
2. 创建新 API Key
3. 复制 key

**Gemini (用于 LLM 分析)**：
1. 访问 https://aistudio.google.com/apikey
2. 创建 API Key
3. 复制 key

### Step 5: 配置 Vercel

1. 访问 https://vercel.com
2. Import GitHub 仓库
3. 设置 Root Directory: `apps/web`
4. 设置环境变量：
   - `PUBLIC_SUPABASE_URL`: Supabase 项目 URL
   - `PUBLIC_SUPABASE_ANON_KEY`: Supabase anon key
   - `SUPABASE_SERVICE_KEY`: Supabase service role key
   - `OPENAI_API_KEY`: OpenAI API Key
5. 获取：
   - Vercel Token: Settings > Tokens
   - Org ID: Settings > General
   - Project ID: Project Settings > General

### Step 6: 配置 GitHub Secrets

1. 进入 GitHub 仓库 > Settings > Secrets and variables > Actions
2. 点击 "New repository secret"
3. 逐个添加上述所有 secrets

### Step 7: 首次运行 Pipeline

1. 进入 Actions > Data Pipeline
2. 点击 "Run workflow"
3. 设置 `full_refresh` 为 `true` (首次需要全量处理)
4. 点击 "Run workflow"
5. 等待完成 (约 30-60 分钟，取决于 Skills 数量)

## 四、Vercel 项目配置

### 4.1 环境变量

在 Vercel Dashboard > Project > Settings > Environment Variables 配置：

| 变量名 | 说明 | 环境 |
|--------|------|------|
| `PUBLIC_SUPABASE_URL` | Supabase 项目 URL | Production, Preview, Development |
| `PUBLIC_SUPABASE_ANON_KEY` | Supabase anon key | Production, Preview, Development |
| `SUPABASE_SERVICE_KEY` | Supabase service role key | Production |
| `OPENAI_API_KEY` | OpenAI API Key | Production |

### 4.2 构建设置

| 设置项 | 值 |
|--------|-----|
| Framework Preset | SvelteKit |
| Root Directory | `apps/web` |
| Build Command | `pnpm build` |
| Output Directory | `.svelte-kit` |
| Install Command | `pnpm install` |

### 4.3 域名配置

1. 在 Vercel Dashboard > Project > Settings > Domains
2. 添加自定义域名 (如 `shareskill.run`)
3. 按提示配置 DNS 记录

## 五、NPM 发布配置

### 5.1 创建 NPM Token

1. 访问 https://www.npmjs.com/settings/tokens
2. 点击 "Generate New Token"
3. 选择 "Automation" 类型
4. 复制 token 到 `NPM_TOKEN` secret

### 5.2 发布新版本

```sh
# 更新版本号
cd apps/hub
pnpm version patch  # 或 minor / major

# 提交并打 tag
git add .
git commit -m "chore: bump hub version"
git tag hub-v1.0.1
git push && git push --tags
```

GitHub Actions 会自动发布到 npm。

## 六、监控与维护

### 6.1 Pipeline 监控

- 查看 Actions 运行日志
- 监控 Supabase 数据库增长
- 检查 LLM API 用量

### 6.2 常见问题

**Pipeline 超时**：
- 增加 `timeout-minutes`
- 或分批处理

**GitHub Rate Limit**：
- 添加更多 GitHub tokens
- Pipeline 会自动轮换使用

**LLM API 错误**：
- 检查 API Key 有效性
- 检查配额是否用完

**Embedding 失败**：
- 检查 OpenAI API Key
- Pipeline 会自动重试 3 次

### 6.3 数据备份

建议定期备份 Supabase 数据：

```sh
# 使用 Supabase CLI
supabase db dump -f backup.sql
```

### 6.4 刷新统计

Pipeline 完成后会自动刷新，也可手动执行：

```sql
SELECT refresh_skills_summary();
```

## 七、环境变量汇总

### GitHub Secrets (共 9 个)

```
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
GITHUB_TOKENS=ghp_xxx1,ghp_xxx2,ghp_xxx3
OPENAI_API_KEY=sk-xxx
GEMINI_API_KEY=AIzaSy...
VERCEL_TOKEN=xxx
VERCEL_ORG_ID=team_xxx
VERCEL_PROJECT_ID=prj_xxx
NPM_TOKEN=npm_xxx
```

### Vercel 环境变量 (共 4 个)

```
PUBLIC_SUPABASE_URL=https://xxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
OPENAI_API_KEY=sk-xxx
```

## 八、检查清单

部署前确认：

- [ ] Supabase 项目已创建
- [ ] 数据库 migrations 已执行
- [ ] GitHub Secrets 已配置 (9 个)
- [ ] Vercel 项目已配置
- [ ] Vercel 环境变量已设置 (4 个)
- [ ] 首次 Pipeline 已运行
- [ ] NPM Token 已配置 (如需发布 Hub)

上线后确认：

- [ ] Web 页面可访问
- [ ] 搜索功能正常
- [ ] 分类列表正确
- [ ] Skill 详情页正常
- [ ] Pipeline 定时任务正常
