# ShareSkill 后台管理设计

## 一、概述

Admin Panel 为平台管理员提供数据监控、内容管理和运营支持能力。

**访问路径**: `/shareadmin`
**认证方式**: 密码认证 (环境变量 `ADMIN_PASSWORD`)

## 二、认证机制

### 2.1 实现方案

采用简单密码 + Session Token 的认证方式：

```typescript
// apps/web/src/lib/server/admin.ts
import { env } from '$env/dynamic/private';

const ADMIN_PASSWORD = env.ADMIN_PASSWORD || '';
const SESSION_COOKIE_NAME = 'admin_session';
const SESSION_MAX_AGE = 60 * 60 * 24; // 24 hours

// 内存存储 session (简单实现，重启后失效)
const activeSessions = new Map<string, number>();

export function isAdminEnabled(): boolean {
  return !!ADMIN_PASSWORD;
}

export function validatePassword(password: string): boolean {
  if (!ADMIN_PASSWORD) return false;
  return password === ADMIN_PASSWORD;
}

export function createSession(): string {
  const token = generateSessionToken(); // 32字节随机hex
  activeSessions.set(token, Date.now() + SESSION_MAX_AGE * 1000);
  return token;
}

export function validateSession(token: string | undefined): boolean {
  if (!token) return false;
  const expiry = activeSessions.get(token);
  if (!expiry) return false;
  if (Date.now() > expiry) {
    activeSessions.delete(token);
    return false;
  }
  return true;
}
```

### 2.2 环境变量

```sh
# 设置后台密码，不设置则后台不可用
ADMIN_PASSWORD=your-secure-password
```

### 2.3 登录流程

1. 访问 `/shareadmin/*` 任意页面
2. Layout 检查 session cookie
3. 未认证则跳转到 `/shareadmin/login`
4. 输入密码验证
5. 验证成功创建 session，跳转后台首页
6. Cookie 有效期 24 小时

## 三、功能模块

### 3.1 数据概览 (Dashboard)

**路径**: `/shareadmin`

**展示内容**:

```
+-------------------------------------------------------------+
|  ShareSkill Admin                               [Logout]     |
+-------------------------------------------------------------+
|                                                             |
|  +----------+  +----------+  +----------+  +----------+    |
|  |  3,016   |  |   275    |  |  2,847   |  |   156    |    |
|  |  Skills  |  |  Repos   |  |  Searches |  | Installs |    |
|  +----------+  +----------+  +----------+  +----------+    |
|                                                             |
|  Category Distribution          High Risk Skills            |
|  +--------------------+        +------------------------+   |
|  | coding      523    |        | skill-a (3 high)       |   |
|  | devops      312    |        | skill-b (2 high)       |   |
|  | ai          287    |        | skill-c (1 high)       |   |
|  | design      245    |        +------------------------+   |
|  +--------------------+                                     |
|                                                             |
|  Top Searches (24h)            Featured Skills              |
|  +--------------------+        +------------------------+   |
|  | 1. pdf (89)        |        | frontend-design        |   |
|  | 2. react (67)      |        | git-workflow           |   |
|  | 3. git (52)        |        | code-review            |   |
|  +--------------------+        +------------------------+   |
+-------------------------------------------------------------+
```

**数据指标**:
- Skills 总数
- 收录的仓库数
- 搜索次数 (从 search_logs 统计)
- 安装次数 (从 events 统计)
- 分类分布
- 高风险 Skills 列表
- 热门搜索词 Top 10
- 精选 Skills 列表

### 3.2 Skills 管理

**路径**: `/shareadmin/skills`

**功能**:

1. **列表查看**
   - 分页展示所有 Skills
   - 支持按分类、警告级别筛选
   - 支持搜索

2. **精选管理**
   - 设置/取消精选状态
   - 精选 Skills 在首页优先展示
   - 最多 20 个精选

3. **问题标记**
   - 标记问题 Skills (内容不当、安全问题等)
   - 标记后从搜索结果中隐藏
   - 记录标记原因和时间

4. **详情查看**
   - 链接到前台详情页

**列表界面**:

```
+-------------------------------------------------------------+
|  Skills                         [Search...]   [Filter v]    |
+-------------------------------------------------------------+
|  [ ] Name              Category  Stars  Warnings  Actions   |
|  ---------------------------------------------------------  |
|  [*] frontend-design   design    1247   0        [View][F] |
|  [ ] pdf-processor     data      456    2        [View][F] |
|  [*] git-workflow      devtools  892    0        [View][-] |
|  [!] risky-skill       coding    123    5        [View][X] |
|  ...                                                        |
+-------------------------------------------------------------+
|  Total: 3,016    < 1 2 3 4 5 ... 151 >                      |
+-------------------------------------------------------------+

[*] = Featured  [!] = Flagged
[F] = Feature   [-] = Unfeature  [X] = Flag/Unflag
```

### 3.3 访问统计

**路径**: `/shareadmin/analytics`

**功能**:

1. **搜索分析**
   - 热门搜索词 Top 20
   - 零结果搜索词 (用于发现需求)
   - 总搜索次数

2. **事件统计**
   - 按事件类型分布 (view, search, download, install)
   - 按来源分布 (web, mcp, api)

**统计界面**:

```
+-------------------------------------------------------------+
|  Analytics                                                  |
+-------------------------------------------------------------+
|                                                             |
|  Event Summary                                              |
|  +------------------+  +------------------+                 |
|  | Views:    12,456 |  | Downloads:  892 |                 |
|  | Searches:  3,421 |  | Installs:   156 |                 |
|  +------------------+  +------------------+                 |
|                                                             |
|  Top Searches                 Zero-Result Searches          |
|  +--------------------+      +------------------------+     |
|  | 1. pdf (1,247)     |      | 1. kubernetes-deploy   |     |
|  | 2. react (892)     |      | 2. aws-lambda          |     |
|  | 3. git (756)       |      | 3. docker-compose      |     |
|  +--------------------+      +------------------------+     |
|                                                             |
|  Source Distribution                                        |
|  +--------------------------------------------------+      |
|  | Web: 78% ================================        |      |
|  | MCP: 18% ========                                |      |
|  | API:  4% ==                                      |      |
|  +--------------------------------------------------+      |
+-------------------------------------------------------------+
```

### 3.4 安全监控

**路径**: `/shareadmin/security`

**功能**:

1. **高风险 Skills**
   - 列出所有含 high severity 警告的 Skills
   - 按警告数排序
   - 快速标记/处理

2. **警告统计**
   - 按严重级别分布 (high/medium/low)
   - 按警告类型分布 (prompt_injection, malicious_code, etc.)
   - 总警告数

3. **最新入库**
   - 最近 24 小时新增的 Skills
   - 用于监控新收录内容质量

## 四、数据库设计

### 4.1 新增字段 (skills 表)

```sql
-- Migration: add_admin_fields_to_skills
ALTER TABLE skills ADD COLUMN IF NOT EXISTS is_featured boolean DEFAULT false;
ALTER TABLE skills ADD COLUMN IF NOT EXISTS is_flagged boolean DEFAULT false;
ALTER TABLE skills ADD COLUMN IF NOT EXISTS flag_reason text;
ALTER TABLE skills ADD COLUMN IF NOT EXISTS flagged_at timestamptz;
ALTER TABLE skills ADD COLUMN IF NOT EXISTS flagged_by text;

-- Partial indexes for fast queries
CREATE INDEX IF NOT EXISTS idx_skills_featured ON skills(is_featured) WHERE is_featured = true;
CREATE INDEX IF NOT EXISTS idx_skills_flagged ON skills(is_flagged) WHERE is_flagged = true;
```

### 4.2 管理员操作日志表

```sql
-- Migration: create_admin_logs_table
CREATE TABLE IF NOT EXISTS admin_logs (
  id bigserial PRIMARY KEY,
  admin_email text NOT NULL DEFAULT 'system',
  action text NOT NULL,           -- 'feature', 'unfeature', 'flag', 'unflag'
  target_skill_id bigint REFERENCES skills(id) ON DELETE SET NULL,
  target_skill_key text,          -- Backup in case skill is deleted
  details jsonb DEFAULT '{}',     -- Additional context (e.g., flag_reason)
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_admin_logs_created ON admin_logs(created_at DESC);
CREATE INDEX idx_admin_logs_skill ON admin_logs(target_skill_id);
```

### 4.3 统计查询函数

```sql
-- Get dashboard statistics
CREATE OR REPLACE FUNCTION get_admin_dashboard_stats()
RETURNS jsonb AS $$
DECLARE
  result jsonb;
BEGIN
  SELECT jsonb_build_object(
    'total_skills', (SELECT COUNT(*) FROM skills),
    'total_repos', (SELECT COUNT(DISTINCT repo_full_name) FROM skills),
    'featured_count', (SELECT COUNT(*) FROM skills WHERE is_featured = true),
    'flagged_count', (SELECT COUNT(*) FROM skills WHERE is_flagged = true),
    'total_searches', (SELECT COUNT(*) FROM search_logs),
    'total_events', (SELECT COUNT(*) FROM events),
    'category_distribution', (
      SELECT COALESCE(jsonb_object_agg(category, cnt), '{}')
      FROM (
        SELECT category, COUNT(*)::int as cnt
        FROM skills
        WHERE category IS NOT NULL
        GROUP BY category
        ORDER BY cnt DESC
      ) t
    ),
    'warning_distribution', (
      SELECT jsonb_build_object(
        'high', (SELECT COUNT(*) FROM skills WHERE security_warnings::text LIKE '%"severity":"high"%'),
        'medium', (SELECT COUNT(*) FROM skills WHERE security_warnings::text LIKE '%"severity":"medium"%'),
        'low', (SELECT COUNT(*) FROM skills WHERE security_warnings::text LIKE '%"severity":"low"%'),
        'none', (SELECT COUNT(*) FROM skills WHERE security_warnings = '[]'::jsonb OR security_warnings IS NULL)
      )
    )
  ) INTO result;

  RETURN result;
END;
$$ LANGUAGE plpgsql;

-- Get high risk skills (with high severity warnings)
CREATE OR REPLACE FUNCTION get_high_risk_skills(limit_count integer DEFAULT 20)
RETURNS TABLE (
  id bigint,
  skill_key text,
  skill_slug text,
  name text,
  repo_full_name text,
  repo_stars integer,
  high_warning_count integer,
  total_warning_count integer,
  is_flagged boolean
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    s.id,
    s.skill_key,
    s.skill_slug,
    s.name,
    s.repo_full_name,
    s.repo_stars,
    (SELECT COUNT(*)::int FROM jsonb_array_elements(s.security_warnings) w WHERE w->>'severity' = 'high') as high_warning_count,
    jsonb_array_length(COALESCE(s.security_warnings, '[]'::jsonb))::int as total_warning_count,
    COALESCE(s.is_flagged, false) as is_flagged
  FROM skills s
  WHERE s.security_warnings IS NOT NULL
    AND s.security_warnings != '[]'::jsonb
    AND EXISTS (
      SELECT 1 FROM jsonb_array_elements(s.security_warnings) w
      WHERE w->>'severity' = 'high'
    )
  ORDER BY high_warning_count DESC, total_warning_count DESC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

-- Get top searches
CREATE OR REPLACE FUNCTION get_top_searches(limit_count integer DEFAULT 20, hours integer DEFAULT 24)
RETURNS TABLE (
  query text,
  count bigint
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    sl.query,
    COUNT(*) as count
  FROM search_logs sl
  WHERE sl.created_at > now() - (hours || ' hours')::interval
  GROUP BY sl.query
  ORDER BY count DESC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

-- Get zero-result searches
CREATE OR REPLACE FUNCTION get_zero_result_searches(limit_count integer DEFAULT 20)
RETURNS TABLE (
  query text,
  count bigint
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    sl.query,
    COUNT(*) as count
  FROM search_logs sl
  WHERE sl.results_count = 0
    AND sl.created_at > now() - interval '7 days'
  GROUP BY sl.query
  ORDER BY count DESC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;
```

## 五、API 接口设计

### 5.1 Dashboard API

**GET /api/admin/dashboard**

获取 Dashboard 概览数据。

**Response**:
```typescript
interface DashboardResponse {
  success: true;
  data: {
    stats: {
      total_skills: number;
      total_repos: number;
      featured_count: number;
      flagged_count: number;
      total_searches: number;
      total_events: number;
    };
    category_distribution: Record<string, number>;
    warning_distribution: {
      high: number;
      medium: number;
      low: number;
      none: number;
    };
    high_risk_skills: Array<{
      id: number;
      skill_key: string;
      skill_slug: string;
      name: string;
      repo_full_name: string;
      high_warning_count: number;
      is_flagged: boolean;
    }>;
    top_searches: Array<{
      query: string;
      count: number;
    }>;
    featured_skills: Array<{
      id: number;
      skill_key: string;
      skill_slug: string;
      name: string;
    }>;
  };
}
```

### 5.2 Skills 管理 API

**GET /api/admin/skills**

获取 Skills 列表 (管理视角)。

**Query Parameters**:
| 参数 | 类型 | 默认值 | 说明 |
|-----|-----|-------|-----|
| page | number | 1 | 页码 |
| limit | number | 20 | 每页数量 |
| search | string | - | 搜索关键词 |
| category | string | - | 分类筛选 |
| featured | boolean | - | 只看精选 |
| flagged | boolean | - | 只看标记 |
| has_warnings | boolean | - | 只看有警告的 |

**Response**:
```typescript
interface AdminSkillsResponse {
  success: true;
  data: {
    items: Array<{
      id: number;
      skill_key: string;
      skill_slug: string;
      name: string;
      tagline: string;
      category: string;
      repo_full_name: string;
      repo_stars: number;
      warning_count: number;
      high_warning_count: number;
      is_featured: boolean;
      is_flagged: boolean;
      flag_reason: string | null;
      created_at: string;
    }>;
    pagination: {
      page: number;
      limit: number;
      total: number;
      total_pages: number;
    };
  };
}
```

**POST /api/admin/skills/:id/feature**

设置 Skill 为精选。

**Response**:
```typescript
{ success: true; data: { is_featured: true } }
```

**DELETE /api/admin/skills/:id/feature**

取消精选。

**Response**:
```typescript
{ success: true; data: { is_featured: false } }
```

**POST /api/admin/skills/:id/flag**

标记问题 Skill。

**Request Body**:
```typescript
{ reason: string }  // Required
```

**Response**:
```typescript
{ success: true; data: { is_flagged: true; flag_reason: string } }
```

**DELETE /api/admin/skills/:id/flag**

取消标记。

**Response**:
```typescript
{ success: true; data: { is_flagged: false } }
```

### 5.3 Analytics API

**GET /api/admin/analytics**

获取访问统计数据。

**Query Parameters**:
| 参数 | 类型 | 默认值 | 说明 |
|-----|-----|-------|-----|
| hours | number | 24 | 统计时间范围 (小时) |

**Response**:
```typescript
interface AnalyticsResponse {
  success: true;
  data: {
    event_summary: {
      views: number;
      searches: number;
      downloads: number;
      installs: number;
    };
    source_distribution: Record<string, number>;  // { web: 78, mcp: 18, api: 4 }
    top_searches: Array<{ query: string; count: number }>;
    zero_result_searches: Array<{ query: string; count: number }>;
  };
}
```

### 5.4 Security API

**GET /api/admin/security**

获取安全监控数据。

**Response**:
```typescript
interface SecurityResponse {
  success: true;
  data: {
    warning_distribution: {
      high: number;
      medium: number;
      low: number;
      none: number;
    };
    warning_type_distribution: {
      prompt_injection: number;
      malicious_code: number;
      data_exfiltration: number;
      credential_exposure: number;
      destructive_operation: number;
      other: number;
    };
    high_risk_skills: Array<{
      id: number;
      skill_key: string;
      skill_slug: string;
      name: string;
      repo_full_name: string;
      repo_stars: number;
      high_warning_count: number;
      total_warning_count: number;
      is_flagged: boolean;
    }>;
    recent_skills: Array<{
      id: number;
      skill_key: string;
      name: string;
      warning_count: number;
      created_at: string;
    }>;
  };
}
```

## 六、前端页面设计

### 6.1 路由结构

```
apps/web/src/routes/shareadmin/
+-- +layout.svelte           # Admin 布局 (红色主题侧边栏)
+-- +layout.server.ts        # 认证检查
+-- +page.svelte             # Dashboard
+-- +page.server.ts          # Dashboard 数据
+-- login/
|   +-- +page.svelte         # 登录页
|   +-- +page.server.ts      # 登录处理
+-- logout/
|   +-- +page.server.ts      # 登出处理
+-- skills/
|   +-- +page.svelte         # Skills 列表
|   +-- +page.server.ts      # Skills 数据
+-- analytics/
|   +-- +page.svelte         # 访问统计
|   +-- +page.server.ts      # 统计数据
+-- security/
    +-- +page.svelte         # 安全监控
    +-- +page.server.ts      # 安全数据
```

### 6.2 Admin 布局组件

```svelte
<!-- +layout.svelte (红色主题) -->
<script lang="ts">
  import { page } from '$app/stores';
  let { children, data } = $props();

  const navItems = [
    { href: '/shareadmin', label: 'Dashboard', icon: 'chart' },
    { href: '/shareadmin/skills', label: 'Skills', icon: 'cube' },
    { href: '/shareadmin/analytics', label: 'Analytics', icon: 'graph' },
    { href: '/shareadmin/security', label: 'Security', icon: 'shield' },
  ];
</script>

{#if data.isAuthenticated}
<div class="flex min-h-screen">
  <!-- Sidebar (红色主题) -->
  <aside class="w-64 bg-red-900 text-white flex-shrink-0">
    <div class="p-4 border-b border-red-700">
      <a href="/shareadmin" class="text-xl font-bold">ShareSkill Admin</a>
    </div>
    <nav class="p-4">
      {#each navItems as item}
        <a
          href={item.href}
          class="block px-4 py-2 rounded mb-1 {$page.url.pathname === item.href ? 'bg-red-700' : 'hover:bg-red-800'}"
        >
          {item.label}
        </a>
      {/each}
    </nav>
    <div class="absolute bottom-0 w-64 p-4 border-t border-red-700 space-y-2">
      <a href="/" class="block text-red-300 hover:text-white text-sm">Back to Site</a>
      <form action="/shareadmin/logout" method="POST">
        <button class="text-red-300 hover:text-white text-sm">Logout</button>
      </form>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 bg-gray-100 p-8">
    {@render children()}
  </main>
</div>
{:else}
  {@render children()}
{/if}
```

### 6.3 登录页面

```svelte
<!-- login/+page.svelte -->
<script lang="ts">
  import { enhance } from '$app/forms';
  let { form } = $props();
</script>

<div class="min-h-screen bg-red-900 flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-xl w-96">
    <h1 class="text-2xl font-bold text-center mb-6">ShareSkill Admin</h1>

    {#if form?.error}
      <div class="bg-red-100 text-red-700 p-3 rounded mb-4">{form.error}</div>
    {/if}

    <form method="POST" use:enhance>
      <input
        type="password"
        name="password"
        placeholder="Admin Password"
        class="w-full p-3 border rounded mb-4"
        required
      />
      <button class="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700">
        Login
      </button>
    </form>
  </div>
</div>
```

## 七、实施状态

### Phase 1: 基础框架 [已完成]
- [x] 路由结构 (`/shareadmin/*`)
- [x] 认证机制 (密码 + session)
- [x] 布局组件 (红色主题)
- [x] 登录/登出页面

### Phase 2: 数据库迁移 [已完成]
- [x] 添加 skills 表 admin 字段 (is_featured, is_flagged, flag_reason, flagged_at)
- [x] 创建 admin_logs 表
- [x] 创建统计查询函数 (get_high_risk_skills, get_top_searches, get_zero_result_searches)

### Phase 3: API 端点 [已完成]
- [x] POST/DELETE /api/shareadmin/skills/:id/feature
- [x] POST/DELETE /api/shareadmin/skills/:id/flag

### Phase 4: 前端页面 [已完成]
- [x] Admin 布局 (红色主题侧边栏)
- [x] 登录页面
- [x] Dashboard 页面 (统计概览、分类分布、高风险 Skills、热门搜索)
- [x] Skills 管理页面 (列表、筛选、精选/标记操作)
- [x] Analytics 页面 (事件统计、来源分布、零结果搜索)
- [x] Security 页面 (警告分布、高风险 Skills、最近添加)

### Phase 5: 测试验证 [已完成]
- [x] 访问 /shareadmin 各页面
- [x] 测试精选/标记操作
- [x] 验证统计数据显示
- [x] 验证认证安全性

## 八、运营建议

### 8.1 日常检查清单

- [ ] 检查新增 Skills 的安全警告
- [ ] 查看零结果搜索词，识别用户需求
- [ ] 更新精选 Skills
- [ ] 处理被标记的问题 Skills

### 8.2 指标告警阈值

| 指标 | 告警阈值 |
|-----|---------|
| 高风险 Skills 占比 | > 10% |
| 零结果搜索占比 | > 30% |
| 标记 Skills 数量 | > 50 |
